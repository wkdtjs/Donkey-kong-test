<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donkey Kong (1981) - Retro Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        * {
            font-family: 'Press Start 2P', cursive;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
        }
        
        .game-container {
            image-rendering: pixelated;
        }
        
        canvas {
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        
        .pixel-border {
            border: 4px solid #f39c12;
            box-shadow: 0 0 0 4px #c0392b, 0 0 20px rgba(243, 156, 18, 0.5);
        }
        
        .retro-btn {
            background: linear-gradient(180deg, #e74c3c 0%, #c0392b 100%);
            border: 3px solid #f39c12;
            text-shadow: 2px 2px 0 #000;
            transition: all 0.1s;
        }
        
        .retro-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(243, 156, 18, 0.7);
        }
        
        .retro-btn:active {
            transform: scale(0.95);
        }
        
        .glow-text {
            text-shadow: 0 0 10px #f39c12, 0 0 20px #f39c12, 0 0 30px #f39c12;
        }

        .leaderboard-row:nth-child(odd) {
            background: rgba(243, 156, 18, 0.1);
        }
        
        .leaderboard-row:nth-child(even) {
            background: rgba(231, 76, 60, 0.1);
        }
    </style>
</head>
<body class="text-white overflow-x-hidden">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-gray-900 pixel-border rounded-lg p-8 max-w-md w-full">
            <h1 class="text-2xl text-yellow-400 glow-text text-center mb-2">DONKEY KONG</h1>
            <p class="text-xs text-red-500 text-center mb-8">~ 1981 EDITION ~</p>
            
            <div class="space-y-6">
                <div>
                    <label class="text-xs text-yellow-400 block mb-2">PLAYER NAME</label>
                    <input type="text" id="playerName" 
                           class="w-full bg-gray-800 border-2 border-yellow-600 rounded p-3 text-white text-sm focus:outline-none focus:border-yellow-400"
                           placeholder="Enter name..." maxlength="12">
                </div>
                
                <div>
                    <label class="text-xs text-yellow-400 block mb-2">STUDENT ID</label>
                    <input type="text" id="studentId" 
                           class="w-full bg-gray-800 border-2 border-yellow-600 rounded p-3 text-white text-sm focus:outline-none focus:border-yellow-400"
                           placeholder="Enter ID..." maxlength="15">
                </div>
                
                <button onclick="login()" class="retro-btn w-full py-4 rounded text-white text-sm">
                    START GAME
                </button>
                
                <button onclick="showLeaderboard()" class="retro-btn w-full py-3 rounded text-white text-xs bg-gradient-to-b from-blue-600 to-blue-800">
                    VIEW LEADERBOARD
                </button>
            </div>
            
            <div class="mt-6 text-center">
                <p class="text-xs text-gray-500">Use ARROW KEYS to move</p>
                <p class="text-xs text-gray-500">SPACE to jump</p>
            </div>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="hidden min-h-screen flex flex-col items-center justify-center p-4">
        <div class="mb-4 flex items-center gap-8">
            <div class="text-center">
                <p class="text-xs text-yellow-400">PLAYER</p>
                <p id="displayName" class="text-sm text-white">---</p>
            </div>
            <div class="text-center">
                <p class="text-xs text-yellow-400">SCORE</p>
                <p id="scoreDisplay" class="text-xl text-red-500 glow-text">0</p>
            </div>
            <div class="text-center">
                <p class="text-xs text-yellow-400">LIVES</p>
                <p id="livesDisplay" class="text-xl text-red-500">❤❤❤</p>
            </div>
            <div class="text-center">
                <p class="text-xs text-yellow-400">LEVEL</p>
                <p id="levelDisplay" class="text-xl text-white">1</p>
            </div>
        </div>
        
        <div class="game-container pixel-border rounded">
            <canvas id="gameCanvas" width="512" height="448"></canvas>
        </div>
        
        <div class="mt-4 flex gap-4">
            <button onclick="restartGame()" class="retro-btn px-6 py-2 rounded text-xs">RESTART</button>
            <button onclick="backToMenu()" class="retro-btn px-6 py-2 rounded text-xs bg-gradient-to-b from-gray-600 to-gray-800">MENU</button>
        </div>
        
        <!-- Mobile Controls -->
        <div class="mt-4 md:hidden grid grid-cols-3 gap-2 w-48">
            <div></div>
            <button ontouchstart="mobileControl('up')" ontouchend="mobileControlEnd('up')" class="retro-btn p-4 rounded text-lg">▲</button>
            <div></div>
            <button ontouchstart="mobileControl('left')" ontouchend="mobileControlEnd('left')" class="retro-btn p-4 rounded text-lg">◀</button>
            <button ontouchstart="mobileControl('jump')" ontouchend="mobileControlEnd('jump')" class="retro-btn p-4 rounded text-xs">JUMP</button>
            <button ontouchstart="mobileControl('right')" ontouchend="mobileControlEnd('right')" class="retro-btn p-4 rounded text-lg">▶</button>
            <div></div>
            <button ontouchstart="mobileControl('down')" ontouchend="mobileControlEnd('down')" class="retro-btn p-4 rounded text-lg">▼</button>
            <div></div>
        </div>
    </div>

    <!-- Leaderboard Screen -->
    <div id="leaderboardScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-gray-900 pixel-border rounded-lg p-6 max-w-lg w-full">
            <h2 class="text-xl text-yellow-400 glow-text text-center mb-6">HIGH SCORES</h2>
            
            <div class="space-y-2 max-h-96 overflow-y-auto" id="leaderboardList">
                <p class="text-center text-gray-500 text-xs">Loading...</p>
            </div>
            
            <button onclick="backToLogin()" class="retro-btn w-full py-3 rounded text-white text-xs mt-6">
                BACK TO MENU
            </button>
        </div>
    </div>

    <!-- Game Over Modal -->
    <div id="gameOverModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
        <div class="bg-gray-900 pixel-border rounded-lg p-8 text-center">
            <h2 class="text-2xl text-red-500 glow-text mb-4">GAME OVER</h2>
            <p class="text-yellow-400 text-sm mb-2">FINAL SCORE</p>
            <p id="finalScore" class="text-3xl text-white mb-6">0</p>
            <div class="space-y-3">
                <button onclick="restartGame()" class="retro-btn w-full py-3 rounded text-sm">PLAY AGAIN</button>
                <button onclick="backToMenu()" class="retro-btn w-full py-3 rounded text-xs bg-gradient-to-b from-gray-600 to-gray-800">MAIN MENU</button>
            </div>
        </div>
    </div>

    <!-- Victory Modal -->
    <div id="victoryModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
        <div class="bg-gray-900 pixel-border rounded-lg p-8 text-center">
            <h2 class="text-2xl text-yellow-400 glow-text mb-4">VICTORY!</h2>
            <p class="text-green-400 text-sm mb-2">YOU SAVED PAULINE!</p>
            <p class="text-yellow-400 text-sm mb-2">SCORE</p>
            <p id="victoryScore" class="text-3xl text-white mb-6">0</p>
            <div class="space-y-3">
                <button onclick="nextLevel()" class="retro-btn w-full py-3 rounded text-sm">NEXT LEVEL</button>
                <button onclick="backToMenu()" class="retro-btn w-full py-3 rounded text-xs bg-gradient-to-b from-gray-600 to-gray-800">MAIN MENU</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCnPNUCMQlQmPJJ3C76agBWv6zcMQk22hM",
            authDomain: "donkey-kong-ad236.firebaseapp.com",
            databaseURL: "https://donkey-kong-ad236-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "donkey-kong-ad236",
            storageBucket: "donkey-kong-ad236.firebasestorage.app",
            messagingSenderId: "87739350642",
            appId: "1:87739350642:web:11dc8bad05af8e14024ceb",
            measurementId: "G-LJEPXLFS34"
        };

        let database;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
        } catch (e) {
            console.log("Firebase not configured - using local storage");
        }

        // Game State
        let canvas, ctx;
        let player = { name: '', studentId: '' };
        let gameState = {
            score: 0,
            lives: 3,
            level: 1,
            isRunning: false
        };

        // Game Constants
        const GRAVITY = 0.4;
        const JUMP_FORCE = -9;
        const MOVE_SPEED = 2.5;
        const CLIMB_SPEED = 2;
        const CANVAS_WIDTH = 512;
        const CANVAS_HEIGHT = 448;

        // Game Objects
        let mario = {};
        let donkeyKong = {};
        let pauline = {};
        let barrels = [];
        let platforms = [];
        let ladders = [];
        let keys = { left: false, right: false, up: false, down: false, jump: false };
        let canJump = true;

        // Platform definitions - 6 levels of platforms
        const PLATFORM_HEIGHT = 8;
        const platformLevels = [
            { y: 410, leftX: 0, rightX: 512 },      // Ground - Level 0
            { y: 350, leftX: 30, rightX: 512 },     // Level 1 - slopes right to left
            { y: 290, leftX: 0, rightX: 482 },      // Level 2 - slopes left to right
            { y: 230, leftX: 30, rightX: 512 },     // Level 3 - slopes right to left
            { y: 170, leftX: 0, rightX: 482 },      // Level 4 - slopes left to right
            { y: 110, leftX: 30, rightX: 250 }      // Level 5 - Top platform (DK area)
        ];

        function initLevel() {
            platforms = [];
            ladders = [];
            barrels = [];

            // Create platforms with slight slopes
            // Ground
            platforms.push({ x: 0, y: 410, width: 512, height: PLATFORM_HEIGHT, level: 0 });

            // Level 1 - slight upward slope from right to left
            platforms.push({ x: 30, y: 350, width: 482, height: PLATFORM_HEIGHT, level: 1, slopeDir: -1 });

            // Level 2 - slight upward slope from left to right  
            platforms.push({ x: 0, y: 290, width: 482, height: PLATFORM_HEIGHT, level: 2, slopeDir: 1 });

            // Level 3 - slight upward slope from right to left
            platforms.push({ x: 30, y: 230, width: 482, height: PLATFORM_HEIGHT, level: 3, slopeDir: -1 });

            // Level 4 - slight upward slope from left to right
            platforms.push({ x: 0, y: 170, width: 482, height: PLATFORM_HEIGHT, level: 4, slopeDir: 1 });

            // Level 5 - Top (DK platform)
            platforms.push({ x: 30, y: 110, width: 220, height: PLATFORM_HEIGHT, level: 5, slopeDir: 0 });

            // Ladders - connecting platforms properly
            // From ground to level 1
            ladders.push({ x: 480, y: 350, width: 20, height: 60, bottomLevel: 0, topLevel: 1 });
            ladders.push({ x: 100, y: 350, width: 20, height: 60, bottomLevel: 0, topLevel: 1 });
            
            // From level 1 to level 2
            ladders.push({ x: 50, y: 290, width: 20, height: 60, bottomLevel: 1, topLevel: 2 });
            ladders.push({ x: 300, y: 290, width: 20, height: 60, bottomLevel: 1, topLevel: 2 });
            
            // From level 2 to level 3
            ladders.push({ x: 450, y: 230, width: 20, height: 60, bottomLevel: 2, topLevel: 3 });
            ladders.push({ x: 180, y: 230, width: 20, height: 60, bottomLevel: 2, topLevel: 3 });
            
            // From level 3 to level 4
            ladders.push({ x: 80, y: 170, width: 20, height: 60, bottomLevel: 3, topLevel: 4 });
            ladders.push({ x: 350, y: 170, width: 20, height: 60, bottomLevel: 3, topLevel: 4 });
            
            // From level 4 to level 5 (to reach Pauline)
            ladders.push({ x: 200, y: 110, width: 20, height: 60, bottomLevel: 4, topLevel: 5 });

            // Reset Mario
            mario = {
                x: 50,
                y: 378,
                width: 24,
                height: 32,
                vx: 0,
                vy: 0,
                onGround: false,
                climbing: false,
                facing: 1,
                frame: 0,
                currentPlatform: null
            };

            // Donkey Kong position
            donkeyKong = {
                x: 50,
                y: 54,
                width: 64,
                height: 56,
                frame: 0,
                throwTimer: 0
            };

            // Pauline position
            pauline = {
                x: 180,
                y: 78,
                width: 24,
                height: 32
            };

            canJump = true;
        }

        function login() {
            const name = document.getElementById('playerName').value.trim();
            const id = document.getElementById('studentId').value.trim();

            if (!name || !id) {
                alert('Please enter both name and student ID!');
                return;
            }

            player.name = name;
            player.studentId = id;

            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            document.getElementById('displayName').textContent = name;

            startGame();
        }

        function startGame() {
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');

            gameState.score = 0;
            gameState.lives = 3;
            gameState.level = 1;
            gameState.isRunning = true;

            updateUI();
            initLevel();
            requestAnimationFrame(gameLoop);
        }

        let lastTime = 0;
        function gameLoop(timestamp) {
            if (!gameState.isRunning) return;

            const deltaTime = timestamp - lastTime;
            lastTime = timestamp;

            update();
            draw();

            requestAnimationFrame(gameLoop);
        }

        function update() {
            updateMario();
            updateBarrels();
            updateDonkeyKong();
            checkVictory();
        }

        function updateMario() {
            // Horizontal movement
            if (!mario.climbing) {
                if (keys.left) {
                    mario.vx = -MOVE_SPEED;
                    mario.facing = -1;
                } else if (keys.right) {
                    mario.vx = MOVE_SPEED;
                    mario.facing = 1;
                } else {
                    mario.vx = 0;
                }

                // Apply gravity when not climbing
                mario.vy += GRAVITY;
                
                // Limit fall speed
                if (mario.vy > 10) mario.vy = 10;

                // Jump - only when on ground and canJump is true
                if (keys.jump && mario.onGround && canJump) {
                    mario.vy = JUMP_FORCE;
                    mario.onGround = false;
                    canJump = false; // Prevent holding jump
                }
            } else {
                // Climbing
                mario.vx = 0;
                mario.vy = 0;
                
                if (keys.up) {
                    mario.y -= CLIMB_SPEED;
                }
                if (keys.down) {
                    mario.y += CLIMB_SPEED;
                }
            }

            // Reset canJump when key is released
            if (!keys.jump) {
                canJump = true;
            }

            // Check ladder
            let onLadder = null;
            for (let ladder of ladders) {
                if (mario.x + mario.width > ladder.x + 2 && 
                    mario.x < ladder.x + ladder.width - 2 &&
                    mario.y + mario.height > ladder.y &&
                    mario.y + mario.height < ladder.y + ladder.height + 20) {
                    onLadder = ladder;
                    break;
                }
            }

            // Start/stop climbing
            if (onLadder && (keys.up || keys.down)) {
                mario.climbing = true;
                mario.x = onLadder.x + onLadder.width / 2 - mario.width / 2;
            }
            
            // Stop climbing when reaching top or bottom of ladder
            if (mario.climbing && onLadder) {
                if (mario.y + mario.height <= onLadder.y + 5) {
                    // Reached top
                    mario.climbing = false;
                    mario.y = onLadder.y - mario.height;
                    mario.onGround = true;
                }
                if (mario.y + mario.height >= onLadder.y + onLadder.height) {
                    // Reached bottom
                    mario.climbing = false;
                }
            }
            
            if (!onLadder && mario.climbing) {
                mario.climbing = false;
            }

            // Apply velocity
            mario.x += mario.vx;
            mario.y += mario.vy;

            // Platform collision
            if (!mario.climbing) {
                mario.onGround = false;
                
                for (let platform of platforms) {
                    // Check if Mario is landing on platform
                    if (mario.vy >= 0 &&
                        mario.x + mario.width > platform.x &&
                        mario.x < platform.x + platform.width &&
                        mario.y + mario.height >= platform.y &&
                        mario.y + mario.height <= platform.y + 20) {
                        
                        mario.y = platform.y - mario.height;
                        mario.vy = 0;
                        mario.onGround = true;
                        mario.currentPlatform = platform;
                        break;
                    }
                }
            }

            // Screen bounds
            if (mario.x < 0) mario.x = 0;
            if (mario.x > CANVAS_WIDTH - mario.width) mario.x = CANVAS_WIDTH - mario.width;
            
            // Fall off screen
            if (mario.y > CANVAS_HEIGHT) {
                loseLife();
            }

            // Animation frame
            if (mario.vx !== 0 || mario.climbing) {
                mario.frame = (mario.frame + 0.15) % 4;
            }
        }

        function updateDonkeyKong() {
            donkeyKong.throwTimer++;
            
            // Throw barrel every 2-3 seconds depending on level
            const throwInterval = Math.max(60, 150 - gameState.level * 20);
            
            if (donkeyKong.throwTimer >= throwInterval) {
                throwBarrel();
                donkeyKong.throwTimer = 0;
                donkeyKong.frame = (donkeyKong.frame + 1) % 2;
            }
        }

        function throwBarrel() {
            barrels.push({
                x: donkeyKong.x + 50,
                y: donkeyKong.y + 40,
                width: 16,
                height: 14,
                vx: 2,
                vy: 0,
                onGround: false,
                frame: 0,
                currentLevel: 5,
                scored: false
            });
        }

        function updateBarrels() {
            for (let i = barrels.length - 1; i >= 0; i--) {
                let barrel = barrels[i];

                // Apply gravity
                barrel.vy += GRAVITY * 0.8;
                if (barrel.vy > 8) barrel.vy = 8;

                // Move barrel
                barrel.x += barrel.vx;
                barrel.y += barrel.vy;

                // Platform collision for barrels
                barrel.onGround = false;
                
                for (let platform of platforms) {
                    if (barrel.vy >= 0 &&
                        barrel.x + barrel.width > platform.x &&
                        barrel.x < platform.x + platform.width &&
                        barrel.y + barrel.height >= platform.y &&
                        barrel.y + barrel.height <= platform.y + 15) {
                        
                        barrel.y = platform.y - barrel.height;
                        barrel.vy = 0;
                        barrel.onGround = true;
                        
                        // Set direction based on platform slope
                        if (platform.slopeDir === -1) {
                            barrel.vx = -2 - gameState.level * 0.3;
                        } else if (platform.slopeDir === 1) {
                            barrel.vx = 2 + gameState.level * 0.3;
                        }
                        
                        barrel.currentLevel = platform.level;
                        break;
                    }
                }

                // Check if barrel should fall to next platform
                // When barrel reaches edge of platform, it falls
                if (barrel.onGround) {
                    let onAnyPlatform = false;
                    for (let platform of platforms) {
                        if (barrel.x + barrel.width > platform.x &&
                            barrel.x < platform.x + platform.width &&
                            Math.abs((barrel.y + barrel.height) - platform.y) < 5) {
                            onAnyPlatform = true;
                            break;
                        }
                    }
                    if (!onAnyPlatform) {
                        barrel.onGround = false;
                    }
                }

                // Remove barrel if off screen
                if (barrel.y > CANVAS_HEIGHT + 50 || barrel.x < -50 || barrel.x > CANVAS_WIDTH + 50) {
                    barrels.splice(i, 1);
                    continue;
                }

                // Barrel animation
                barrel.frame = (barrel.frame + Math.abs(barrel.vx) * 0.1) % 4;

                // Collision with Mario
                if (checkCollision(mario, barrel)) {
                    barrels.splice(i, 1);
                    loseLife();
                    continue;
                }

                // Score for jumping over barrel
                if (!barrel.scored && 
                    mario.y + mario.height < barrel.y &&
                    Math.abs(mario.x - barrel.x) < 30 &&
                    !mario.onGround) {
                    barrel.scored = true;
                    gameState.score += 100;
                    updateUI();
                }
            }
        }

        function checkCollision(a, b) {
            const padding = 4;
            return a.x + padding < b.x + b.width - padding &&
                   a.x + a.width - padding > b.x + padding &&
                   a.y + padding < b.y + b.height - padding &&
                   a.y + a.height - padding > b.y + padding;
        }

        function checkVictory() {
            if (checkCollision(mario, pauline)) {
                victory();
            }
        }

        function loseLife() {
            gameState.lives--;
            updateUI();
            barrels = [];

            if (gameState.lives <= 0) {
                gameOver();
            } else {
                // Reset Mario position
                mario.x = 50;
                mario.y = 378;
                mario.vx = 0;
                mario.vy = 0;
                mario.onGround = false;
                mario.climbing = false;
                canJump = true;
            }
        }

        function gameOver() {
            gameState.isRunning = false;
            document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('gameOverModal').classList.remove('hidden');
            saveScore();
        }

        function victory() {
            gameState.isRunning = false;
            gameState.score += 1000 + (gameState.level * 500);
            document.getElementById('victoryScore').textContent = gameState.score;
            document.getElementById('victoryModal').classList.remove('hidden');
            updateUI();
            saveScore();
        }

        function nextLevel() {
            document.getElementById('victoryModal').classList.add('hidden');
            gameState.level++;
            gameState.isRunning = true;
            initLevel();
            updateUI();
            lastTime = performance.now();
            requestAnimationFrame(gameLoop);
        }

        // Drawing functions
        function draw() {
            // Clear canvas
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            // Draw platforms
            for (let platform of platforms) {
                drawPlatform(platform);
            }

            // Draw ladders
            for (let ladder of ladders) {
                drawLadder(ladder);
            }

            // Draw Donkey Kong
            drawDonkeyKong();

            // Draw Pauline
            drawPauline();

            // Draw barrels
            for (let barrel of barrels) {
                drawBarrel(barrel);
            }

            // Draw Mario
            drawMario();

            // Draw "HELP!" text
            ctx.fillStyle = '#ff69b4';
            ctx.font = '10px "Press Start 2P"';
            ctx.fillText('HELP!', pauline.x - 5, pauline.y - 10);
        }

        function drawPlatform(platform) {
            ctx.fillStyle = '#e74c3c';
            ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
            
            // Draw girder pattern
            ctx.fillStyle = '#c0392b';
            for (let i = 0; i < platform.width; i += 16) {
                ctx.fillRect(platform.x + i, platform.y, 8, platform.height);
            }
        }

        function drawLadder(ladder) {
            ctx.fillStyle = '#3498db';
            // Sides
            ctx.fillRect(ladder.x, ladder.y, 3, ladder.height);
            ctx.fillRect(ladder.x + ladder.width - 3, ladder.y, 3, ladder.height);
            // Rungs
            for (let i = 5; i < ladder.height; i += 10) {
                ctx.fillRect(ladder.x, ladder.y + i, ladder.width, 2);
            }
        }

        function drawMario() {
            ctx.save();
            ctx.translate(mario.x + mario.width / 2, mario.y + mario.height / 2);
            
            if (mario.facing === -1) {
                ctx.scale(-1, 1);
            }

            // Cap
            ctx.fillStyle = '#e74c3c';
            ctx.fillRect(-10, -16, 18, 6);
            ctx.fillRect(-8, -18, 12, 4);

            // Head
            ctx.fillStyle = '#f5b041';
            ctx.fillRect(-8, -10, 14, 10);

            // Hair/sideburns
            ctx.fillStyle = '#4a2c00';
            ctx.fillRect(-8, -10, 3, 4);

            // Eye
            ctx.fillStyle = '#000';
            ctx.fillRect(2, -8, 3, 3);

            // Mustache
            ctx.fillStyle = '#4a2c00';
            ctx.fillRect(-2, -2, 10, 3);

            // Body (shirt)
            ctx.fillStyle = '#e74c3c';
            ctx.fillRect(-8, 0, 16, 8);

            // Overalls
            ctx.fillStyle = '#3498db';
            ctx.fillRect(-8, 6, 16, 10);
            
            // Overall straps
            ctx.fillRect(-6, 2, 4, 6);
            ctx.fillRect(2, 2, 4, 6);

            // Legs with animation
            if (mario.climbing) {
                let climbOffset = Math.floor(mario.frame) % 2 === 0 ? -2 : 2;
                ctx.fillRect(-7 + climbOffset, 12, 6, 6);
                ctx.fillRect(1 - climbOffset, 12, 6, 6);
            } else if (Math.abs(mario.vx) > 0) {
                let legOffset = Math.floor(mario.frame) % 2 === 0 ? 0 : 3;
                ctx.fillRect(-7, 12, 6, 4 + legOffset);
                ctx.fillRect(1, 12, 6, 4 + (3 - legOffset));
            } else {
                ctx.fillRect(-7, 12, 6, 6);
                ctx.fillRect(1, 12, 6, 6);
            }

            ctx.restore();
        }

        function drawDonkeyKong() {
            ctx.save();
            ctx.translate(donkeyKong.x, donkeyKong.y);

            // Body
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(12, 18, 40, 32);

            // Head
            ctx.fillRect(16, 0, 32, 22);

            // Face
            ctx.fillStyle = '#DEB887';
            ctx.fillRect(20, 4, 24, 16);

            // Eyes
            ctx.fillStyle = '#fff';
            ctx.fillRect(22, 6, 8, 6);
            ctx.fillRect(34, 6, 8, 6);
            ctx.fillStyle = '#000';
            ctx.fillRect(26, 8, 3, 3);
            ctx.fillRect(38, 8, 3, 3);

            // Mouth
            ctx.fillStyle = '#000';
            ctx.fillRect(28, 15, 8, 3);

            // Arms with animation
            ctx.fillStyle = '#8B4513';
            let armOffset = donkeyKong.frame === 0 ? 0 : 5;
            ctx.fillRect(2, 22 - armOffset, 12, 18);
            ctx.fillRect(50, 22 + armOffset, 12, 18);

            // Chest
            ctx.fillStyle = '#DEB887';
            ctx.fillRect(20, 22, 24, 12);

            // Tie
            ctx.fillStyle = '#e74c3c';
            ctx.fillRect(28, 22, 8, 14);

            ctx.restore();
        }

        function drawPauline() {
            ctx.save();
            ctx.translate(pauline.x, pauline.y);

            // Hair
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(4, 0, 16, 6);
            ctx.fillRect(2, 4, 4, 10);
            ctx.fillRect(18, 4, 4, 10);

            // Head
            ctx.fillStyle = '#f5b041';
            ctx.fillRect(6, 2, 12, 12);

            // Eyes
            ctx.fillStyle = '#000';
            ctx.fillRect(8, 6, 2, 2);
            ctx.fillRect(14, 6, 2, 2);

            // Lips
            ctx.fillStyle = '#e74c3c';
            ctx.fillRect(10, 10, 4, 2);

            // Dress
            ctx.fillStyle = '#ff69b4';
            ctx.fillRect(4, 14, 16, 18);

            // Arms
            ctx.fillStyle = '#f5b041';
            ctx.fillRect(0, 14, 4, 10);
            ctx.fillRect(20, 14, 4, 10);

            ctx.restore();
        }

        function drawBarrel(barrel) {
            ctx.save();
            ctx.translate(barrel.x + barrel.width / 2, barrel.y + barrel.height / 2);
            ctx.rotate(barrel.frame * Math.PI / 2);

            // Barrel body
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(-8, -7, 16, 14);

            // Barrel bands
            ctx.fillStyle = '#f39c12';
            ctx.fillRect(-8, -7, 16, 2);
            ctx.fillRect(-8, 5, 16, 2);

            // Center marking
            ctx.fillStyle = '#5D3A1A';
            ctx.fillRect(-3, -3, 6, 6);

            ctx.restore();
        }

        function updateUI() {
            document.getElementById('scoreDisplay').textContent = gameState.score;
            document.getElementById('livesDisplay').textContent = '❤'.repeat(Math.max(0, gameState.lives));
            document.getElementById('levelDisplay').textContent = gameState.level;
        }

        // Firebase functions
        function saveScore() {
            const scoreData = {
                name: player.name,
                studentId: player.studentId,
                score: gameState.score,
                level: gameState.level,
                timestamp: Date.now()
            };

            if (database) {
                database.ref('leaderboard').push(scoreData)
                    .catch(e => saveToLocalStorage(scoreData));
            } else {
                saveToLocalStorage(scoreData);
            }
        }

        function saveToLocalStorage(scoreData) {
            let scores = JSON.parse(localStorage.getItem('dkScores') || '[]');
            scores.push(scoreData);
            scores.sort((a, b) => b.score - a.score);
            scores = scores.slice(0, 10);
            localStorage.setItem('dkScores', JSON.stringify(scores));
        }

        function showLeaderboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('leaderboardScreen').classList.remove('hidden');
            loadLeaderboard();
        }

        function loadLeaderboard() {
            const listEl = document.getElementById('leaderboardList');
            listEl.innerHTML = '<p class="text-center text-gray-500 text-xs">Loading...</p>';

            if (database) {
                database.ref('leaderboard')
                    .orderByChild('score')
                    .limitToLast(10)
                    .once('value')
                    .then(snapshot => {
                        const scores = [];
                        snapshot.forEach(child => scores.push(child.val()));
                        scores.reverse();
                        displayLeaderboard(scores);
                    })
                    .catch(e => displayLeaderboard(JSON.parse(localStorage.getItem('dkScores') || '[]')));
            } else {
                displayLeaderboard(JSON.parse(localStorage.getItem('dkScores') || '[]'));
            }
        }

        function displayLeaderboard(scores) {
            const listEl = document.getElementById('leaderboardList');

            if (scores.length === 0) {
                listEl.innerHTML = '<p class="text-center text-gray-500 text-xs">No scores yet!</p>';
                return;
            }

            listEl.innerHTML = scores.map((s, i) => `
                <div class="leaderboard-row flex justify-between items-center p-3 rounded ${i < 3 ? 'border-l-4 border-yellow-400' : ''}">
                    <div class="flex items-center gap-3">
                        <span class="text-lg ${i === 0 ? 'text-yellow-400' : i === 1 ? 'text-gray-300' : i === 2 ? 'text-orange-400' : 'text-gray-500'}">${i + 1}</span>
                        <div>
                            <p class="text-sm text-white">${s.name}</p>
                            <p class="text-xs text-gray-500">${s.studentId}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-yellow-400">${s.score}</p>
                        <p class="text-xs text-gray-500">LVL ${s.level || 1}</p>
                    </div>
                </div>
            `).join('');
        }

        function backToLogin() {
            document.getElementById('leaderboardScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function backToMenu() {
            gameState.isRunning = false;
            document.getElementById('gameOverModal').classList.add('hidden');
            document.getElementById('victoryModal').classList.add('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function restartGame() {
            document.getElementById('gameOverModal').classList.add('hidden');
            document.getElementById('victoryModal').classList.add('hidden');
            gameState.score = 0;
            gameState.lives = 3;
            gameState.level = 1;
            gameState.isRunning = true;
            initLevel();
            updateUI();
            lastTime = performance.now();
            requestAnimationFrame(gameLoop);
        }

        // Keyboard controls
        document.addEventListener('keydown', (e) => {
            switch(e.key) {
                case 'ArrowLeft':
                case 'a':
                    keys.left = true;
                    break;
                case 'ArrowRight':
                case 'd':
                    keys.right = true;
                    break;
                case 'ArrowUp':
                case 'w':
                    keys.up = true;
                    break;
                case 'ArrowDown':
                case 's':
                    keys.down = true;
                    break;
                case ' ':
                    keys.jump = true;
                    e.preventDefault();
                    break;
            }
        });

        document.addEventListener('keyup', (e) => {
            switch(e.key) {
                case 'ArrowLeft':
                case 'a':
                    keys.left = false;
                    break;
                case 'ArrowRight':
                case 'd':
                    keys.right = false;
                    break;
                case 'ArrowUp':
                case 'w':
                    keys.up = false;
                    break;
                case 'ArrowDown':
                case 's':
                    keys.down = false;
                    break;
                case ' ':
                    keys.jump = false;
                    break;
            }
        });

        // Mobile controls
        function mobileControl(dir) {
            keys[dir] = true;
        }

        function mobileControlEnd(dir) {
            keys[dir] = false;
        }
    </script>
</body>
</html>
